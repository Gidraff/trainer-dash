apiVersion: apps/v1
kind: Deployment
metadata:
  name: fitflow-api
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fitflow-api
  template:
    metadata:
      labels:
        app: fitflow-api
    spec:
      containers:
        # Sidecar: Cloud SQL Proxy
        - name: cloud-sql-proxy
          image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.14.2
          args:
            - "--private-ip"
            - "--port=5432"
            - "gidraff-cloudkite-58sdk3:us-central1:cordiafit-db"
          securityContext:
            runAsNonRoot: true
            runAsUser: 65532
        
        # Primary Container: API with Diagnostic Script
        - name: api
          image: us-central1-docker.pkg.dev/gidraff-cloudkite-58sdk3/fitflow/api:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "=== DIAGNOSTIC MODE ==="
              echo "PWD: $(pwd)"
              echo ""
              
              echo "Binary info:"
              ls -la ./trainer-api || echo "Binary ./trainer-api NOT FOUND in $(pwd)"
              echo ""
              
              echo "Checking binary type:"
              file ./trainer-api || echo "file command failed"
              echo ""
              
              echo "Checking shared library dependencies:"
              ldd ./trainer-api || echo "ldd failed - likely missing glibc or wrong architecture!"
              echo ""
              
              echo "Environment variables check:"
              env | grep -E "DATABASE_URL|KEYCLOAK" || echo "No DB/Keycloak vars set in shell!"
              echo ""
              
              echo "Attempting to run binary..."
              ./trainer-api 2>&1 || {
                EXIT_CODE=$?
                echo "‚ùå Binary exited with code: $EXIT_CODE"
                echo ""
                echo "Checking for missing libraries (detailed):"
                ldd ./trainer-api | grep "not found" || echo "All libraries found (if ldd worked)"
                exit 1
              }
          
          env:
            - name: KEYCLOAK_ISSUER_URL
              value: "https://auth.cordiafit.fit/auth/realms/trainer-app"
            - name: KEYCLOAK_INTERNAL_URL
              value: "http://keycloak-v2.keycloak.svc.cluster.local:8080/auth/realms/trainer-app"
            - name: RUST_LOG
              value: "debug"
            - name: APP_HOST
              value: "0.0.0.0"
            - name: APP_PORT
              value: "8080"
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: fitflow-db-secrets
                  key: username
            - name: DB_PASS
              valueFrom:
                secretKeyRef:
                  name: fitflow-db-secrets
                  key: password
            - name: DB_NAME
              valueFrom:
                secretKeyRef:
                  name: fitflow-db-secrets
                  key: database
            - name: DATABASE_URL
              value: "postgresql://$(DB_USER):$(DB_PASS)@127.0.0.1:5432/$(DB_NAME)"
            # resources:
